import BleUART from './js/bluetooth';

<app>
    <div class="work">
        <div class="container">
            <color-tab ref="colortab" class="contentarea" color="#FFFFFF">
            </color-tab>
            <effect-tab ref="effecttab" class="contentarea" effect="0">
            </effect-tab>
        </div>
        <div class="wrapper_msg invisible">
            <div ref="message"></div>
        </div>
    </div>
    <div class="footer">
        <div each={ buttons } class="button {selected: activeTab === type}"
            onclick="{ footerButtonClick }">
            <div class="icon">{ icon }</div>
            <div class="title">{ title }</div>
        </div>
    </div>
    <connect-dialog show="{showConnect}" ref="connectdialog"></connect-dialog>

    <script>
        var self = this;
        var ble = new BleUART();
        self.showConnect = true;
        self.currentColor = {
            r: 255,
            g: 255,
            b: 255
        };
        self.brightness = 0;
        self.currentDigit = 0;
        self.currentEffect = 0;

        self.buttons = [{
            title: 'Color',
            icon: '0',
            type: 'color'
        },
        {
            title: 'Effect',
            icon: 'e',
            type: 'effect'
        }];
        self.activeTab = 'color';

        ble.on('disconnect', () => {
            stopConnectionTimer();
            self.showConnect = true;
            self.update();
        });

        ble.on('receive', (data) => {
            var buf = new Uint8Array(data);
            for (let i = 0; i < buf.length; i++) {
                switch (buf[i]) {
                    case ble.PROTOCOL_CMD_SET_ICON_COLOR:
                        self.refs.colortab.setColor(
                            buf[i + 1],
                            new tinycolor({ r: buf[i + 2], g: buf[i + 3], b: buf[i + 4] })
                        );
                        i += 4; /* consumed 4 data bytes */
                        break;
                    case ble.PROTOCOL_CMD_SET_BRIGHTNESS:
                        self.refs.colortab.setBrightness(buf[i + 1] / 256);
                        i += 1; /* consumed 1 data byte */
                        break;
                    case ble.PROTOCOL_CMD_SET_EFFECT:
                        self.refs.effecttab.setEffect(buf[i + 1]);
                        i += 1; /* consumed 1 data byte */
                        break;
                    case ble.PROTOCOL_CMD_ADD_EFFECT:
                        self.refs.effecttab.addEffect(buf[i + 1]);
                        i += 1; /* consumed 1 data byte */
                        break;
                    default:
                        console.log("received", buf[i]);
                }
            }
        });

        self.on('mount', () => {
            self.refs.colortab.on('brightness', data => {
                self.brightness = data.brightness;
                sendBrightnessToPSXLight();
            });

            self.refs.colortab.on('color', data => {
                self.currentColor = data.color;
                self.currentDigit = data.pointer;
                sendValuesToPSXLight();
            });

            self.refs.effecttab.on('effect', effect => {
                self.currentEffect = effect;
                sendEffectToPSXLight();
            });

            self.refs.connectdialog.on('connect', () => {
                ble.connect()
                    .then(() => {
                        startConnectionTimer();
                        self.showConnect = false;
                        self.update();
                        showMessage('connected', 'status');
                        ble.send([ble.PROTOCOL_CMD_CONNECTED, 1])
                            .catch(error => {
                                self.sending = false;
                                showMessage(error, 'error')
                            });
                    }).catch(error => showMessage(error, 'error'));
            });

            if ("serviceWorker" in navigator) {
                console.log("register service-worker");
                navigator
                    .serviceWorker
                    .register('/service-worker.js', { scope: './' })
                    .then((reg) => {
                        if (reg.installing) {
                            console.log('Service worker installing');
                        } else if (reg.waiting) {
                            console.log('Service worker installed');
                        } else if (reg.active) {
                            console.log('Service worker active');
                        }
                    })
                    .catch((error) => {
                        // Registration failed
                        console.log('Registration failed with ' + error);
                    });

                // Communicate with the service worker using MessageChannel API.
                function sendMessage(message) {
                    return new Promise((resolve, reject) => {
                        const messageChannel = new MessageChannel();
                        messageChannel.port1.onmessage = function (event) {
                            resolve(`Direct message from SW: ${event.data}`);
                        };
                        navigator
                            .serviceWorker
                            .controller
                            .postMessage(message, [messageChannel.port2])
                    });
                }
            } else {
                console.log("service-worker not supported");

            }
        });

        self.footerButtonClick = (event) => {
            self.update({
                activeTab: event.item.type
            });
            var area, index;
            area = self.refs[event.item.type + 'tab'].root;
            index = area.offsetLeft / area.clientWidth;
            area.parentElement.style.left = (-index * 100) + '%';
        };

        function stopConnectionTimer() {
            if (self.connectionTimer) {
                clearTimeout(self.connectionTimer);
                self.connectionTimer = null;
            }
        };

        function resetConnectionTimer() {
            stopConnectionTimer();
            startConnectionTimer();
        };

        function startConnectionTimer() {
            self.connectionTimer = setTimeout(() => {
                stopConnectionTimer();
                self.showConnect = true;
                self.update();
                ble.send([ble.PROTOCOL_CMD_CONNECTED, 0x00])
                    .then(() => {
                        ble.disconnect();
                        showMessage("disconnected", 'info');
                    }).catch(error => {
                        self.sending = false;
                        showMessage(error, 'error')
                    })
            }, 60000);
        };

        /**
         * Shows a message as notification for the user
         * @param {String} text - message text
         * @param {String} type - message type (status or error)
         */
        function showMessage(text, type) {
            self.refs.message.className = type;
            self.refs.message.textContent = text;

            self.refs.message.parentElement.classList.remove('invisible');

            if (self.timer) {
                clearTimeout(self.timer);
            }
            self.timer = setTimeout(function () {
                self.refs.message.parentElement.classList.add('invisible');
                self.timer = null;
            }, 5000);
        }

        function sendBrightnessToPSXLight() {
            var setBrightness = [ble.PROTOCOL_CMD_SET_BRIGHTNESS, self.brightness * 0xFF]

            if (!self.sending) {
                resetConnectionTimer();
                self.sending = true;
                ble.send(setBrightness)
                    .then(() => {
                        self.sending = false;
                    }).catch(error => {
                        self.sending = false;
                        showMessage(error, 'error')
                    });
            }
        }

        function sendValuesToPSXLight() {
            var setRGB = [ble.PROTOCOL_CMD_SET_ICON_COLOR, self.currentDigit, self.currentColor.r, self.currentColor.g, self.currentColor.b]

            if (!self.sending) {
                resetConnectionTimer();
                self.sending = true;
                ble.send(setRGB)
                    .then(() => {
                        self.sending = false;
                    }).catch(error => {
                        self.sending = false;
                        showMessage(error, 'error')
                    });
            }
        }

        function sendEffectToPSXLight() {
            var setEffect = [ble.PROTOCOL_CMD_SET_EFFECT, self.currentEffect]

            if (!self.sending) {
                resetConnectionTimer();
                self.sending = true;
                ble.send(setEffect)
                    .then(() => {
                        self.sending = false;
                    }).catch(error => {
                        self.sending = false;
                        showMessage(error, 'error')
                    });
            }
        }
    </script>


    <style>
        app {
            height: 100%;
            width: 100%;
            display: -webkit-flex;
            -webkit-flex-direction: column;
            -webkit-flex-wrap: nowrap;
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            background-color: #2C2C2C;
            min-width: 320px;
            min-height: 460px;
        }

        .work {
            -webkit-flex: 1;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .container {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 200%;
            display: flex;
            display: -webkit-flex;
            -webkit-transition: left 0.5s ease-in-out;
            transition: left 0.5s ease-in-out;
        }

        .contentarea {
            width: 100%;
            height: 100%;
            overflow-y: overlay;
            -ms-overflow-y: auto;
            -ms-overflow-style: -ms-autohiding-scrollbar;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .info {
            font-size: 16px;
            position: absolute;
            top: 50%;
            width: 100%;
            text-align: center;
        }

        .footer {
            border-top: 1px solid #919F9F;
            display: -webkit-flex;
            -webkit-justify-content: space-around;
            display: flex;
            justify-content: space-around;
        }

        .footer .button:active,
        .footer .button.selected {
            color: #FFFFFF;
        }

        .footer .button {
            width: 100%;
            text-align: center;
            position: relative;
            padding: 5px;
        }

        .footer .button .icon {
            font-size: 25px;
            margin-top: 8px;
        }

        .footer .button .title {
            font-size: 12px;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .wrapper_msg {
            position: absolute;
            bottom: 5px;
            width: 100%;
            display: -webkit-flex;
            display: flex;
            visibility: visible;
            opacity: 1;
            -webkit-transition: opacity 0.2s linear;
            transition: opacity 0.2s linear;
            justify-content: center;
        }

        .error {
            background-color: #D70000;
            color: #FFFFFF;
        }

        .status {
            background-color: #00A200;
            color: #FFFFFF;
        }

        .wrapper_msg>div {
            padding: 5px 10px;
            font-size: 12px;
            font-weight: bold;
        }

        .contentarea {
            display: flex;
            flex-direction: column;
        }
    </style>
</app>